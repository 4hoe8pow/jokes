---
layout: ../../layouts/BlogLayout.astro
title: 認証・認可プロトコル論
description: IDフェデレーション技術の構造理解（SAML／OAuth等）。
tags: ["認証・認可"]
time: 10
featured: true
timestamp: 2025-08-04T10:57:00+00:00
filename: sc_2
---

## 概要
認証・認可プロトコルは、情報システムにおけるユーザーやサービスの身元確認と権限管理を担う。本章では、現代のWeb・クラウド環境で主流となる認証・認可技術の理論と実装について体系的に述べる。

---

### 1. 認証・認可の基本概念

- **認証（Authentication）**：ユーザやシステムが「誰であるか」を確認する行為。
- **認可（Authorization）**：認証された主体に対して「何ができるか」を制御する行為。
- **ID管理**：ID、属性情報、認証情報の一元管理。IdP（Identity Provider）とSP（Service Provider）の分離が主流。

---

### 2. 認証方式の分類

| 認証方式                    | 説明                                                   | 備考                                        |
| --------------------------- | ------------------------------------------------------ | ------------------------------------------- |
| パスワード認証              | 知識ベース。最も一般的であるが漏洩・総当たり攻撃に弱い | パスワード管理・強度ポリシーが重要          |
| 多要素認証（MFA）           | 知識（Something you know）+ 所持 + 生体の組合せ        | 攻撃耐性が高く、標準化が進む（例：SMS+OTP） |
| 生体認証                    | 指紋、顔、虹彩等                                       | 誤認識率（FAR／FRR）への考慮が必要          |
| ワンタイムパスワード（OTP） | 時間またはイベントベースで変化する一時的パスワード     | TOTP（時間）とHOTP（イベント）が主流        |

---

### 3. 認可方式の分類

| 制御方式 | 概要                                       | 適用例                                     |
| -------- | ------------------------------------------ | ------------------------------------------ |
| RBAC     | ロールに基づいてアクセス権を付与           | 組織階層型のシステム設計に有効             |
| ABAC     | 属性（ユーザー属性・環境属性など）に基づく | 柔軟性が高く、ポリシー管理が複雑になりがち |
| PBAC     | ビジネスルールに基づいた動的アクセス制御   | クラウド／API連携などで導入増加中          |

---

### 4. IDフェデレーション技術

#### 🧭 はじめに

IDフェデレーションとは、異なるドメイン（企業、クラウドサービス、アプリ）間で**認証情報を安全に共有し合う仕組み**を指す。認証機能をIdP（Identity Provider）に集中させ、各種サービス（SP：Service Provider）側ではその結果のみを信頼することで、SSO（Single Sign-On）や認可委譲が実現される。

この枠組みを支える主要技術が **SAML 2.0 / OAuth 2.0 / OpenID Connect (OIDC)** である。これらは単なる認証プロトコルではなく、**トークンの発行と検証、データフローと署名の設計、セキュリティの境界線の再定義**といった複雑な構成要素を伴う。

#### 🔗 1. SAML 2.0：XMLベースの企業間SSO標準

- **用途**：B2B環境でのSSO（例：社内ポータル → Salesforce）
- **構成**：IdP、SP、ユーザーの3者間通信
- **データ形式**：XMLベースの「SAMLアサーション」

**処理フロー概略：**
1. ユーザーがSPにアクセス
2. SPがユーザーをIdPへリダイレクト（AuthnRequest）
3. IdPが認証後、署名付きSAMLアサーションをSPへ返却
4. SPは署名検証とアサーションの有効性を確認し、認証完了

**脅威・脆弱性：**
- XML署名の不備 → **SAML署名ラッピング攻撃**
- アサーションの使い回し → **リプレイ攻撃**
- Clock skew、IDの未検証など → **認証バイパス**

**対策：**
- ライブラリの脆弱性回避（OpenSAMLなどの安全利用）
- アサーションの一意性・有効期限・Audience制限の厳格検証
- HTTPS強制、署名の整合性確認

#### 🔑 2. OAuth 2.0：認可のフレームワーク

OAuthは、**「第三者アプリに自分のデータアクセスを許可する仕組み」**を定義した認可のフレームワーク。主にAPIアクセス制御に使用される。

**主なロール：**
- Resource Owner（ユーザー）
- Client（アプリ）
- Authorization Server（認可サーバ）
- Resource Server（API提供者）

**代表的なグラントタイプ：**
- **Authorization Code Flow**：Webアプリで推奨。セキュア。
- **Implicit Flow**（非推奨）：トークンがURLに露出。
- **Client Credentials**：バックエンド連携用。
- **Device Code Flow**：スマートTV等向け。

**攻撃例：**
- リダイレクトURIの不備 → **Open Redirect攻撃**
- トークン窃取 → **CSRFまたはログ流出**
- スコープ過剰要求 → **権限昇格**

#### 🆔 3. OpenID Connect（OIDC）：認証も可能なOAuth拡張

OIDCはOAuth 2.0の上位互換として、**IDトークン（JWT）を用いたユーザー認証**を可能にしたプロトコル。

**追加要素：**
- **ID Token**：ユーザー属性（sub, name, email等）を含むJWT
- **nonce**：リプレイ攻撃防止のためのトークン固有ID
- **userinfoエンドポイント**：ユーザー情報を取得

**検証ポイント：**
- IDトークンの署名（alg: none攻撃を禁止）
- nonceの検証
- iss, aud, exp, iatのチェック

#### 📌 試験・実務の要点

- OAuthとOIDCの**役割分担の違い**を明確に理解（OAuth：認可／OIDC：認証）
- フロー別の脅威モデルと対策（Authorization Code Flow推奨）
- トークン（アクセストークン／IDトークン）の構造と検証項目
- SAML/OIDC間の設計選択（B2B向けかSPA向けか）

---

### 5. 認証・認可プロトコルの実装例

- **SSO（Single Sign-On）**
  - 一度の認証で複数サービスにアクセス可能。SAMLやOIDCにより実現。
- **OAuth連携によるAPIアクセス制御**
  - アクセストークンのスコープ、有効期限、リフレッシュトークン等を設計に反映。
- **OIDCによるID連携**
  - IDトークンの検証（署名アルゴリズム、nonce確認）などが必要。

### 6. セキュリティ課題と対策

#### 📉 セッション管理の失敗 → Session Hijack／Fixation

- **脅威**：攻撃者が有効なセッショントークンを不正取得してログイン状態を乗っ取る
- **対策**：
  - Secure属性／HttpOnly属性／SameSite属性の設定
  - セッションIDは**認証後に再生成**
  - セッションタイムアウト（15分目安）

#### 🔁 CSRF（クロスサイトリクエストフォージェリ）

- **仕組み**：ユーザーがログイン中に悪意あるサイトから勝手にリクエストが送信される
- **対策**：
  - CSRFトークンをフォームに埋め込み、検証
  - SameSite=LaxまたはStrictの設定（特にSPAは要注意）
  - Refererヘッダ／Originヘッダのチェック

#### 🔓 認証情報の漏洩と盗用

- **脆弱性要因**：
  - パスワードの平文保存
  - パスワード再利用
  - 認証ログの露出
- **対策**：
  - ハッシュ＋ソルト（PBKDF2、bcrypt、Argon2）
  - MFA導入
  - ログ監査とアラート設定

#### 🎫 トークンの不正利用（特にJWT）

- **攻撃ベクトル**：
  - alg: noneによる署名スキップ
  - 公開鍵と秘密鍵の誤配置
  - 長寿命トークンによるリプレイ攻撃
- **設計対策**：
  - JWTの**署名アルゴリズムを固定化**
  - exp（有効期限）＋jti（一意識別子）の確認
  - トークンのリフレッシュと失効機構の設計

#### 🧠 パスワードリスト型攻撃（Credential Stuffing）

- **特長**：漏洩済みID/Passwordの再利用攻撃
- **対策**：
  - IP／User-Agentベースのアクセス制限
  - CAPTCHA、MFA
  - リスクベース認証（ログイン挙動のスコアリング）

#### 📌 試験・実務の注目点

- **JWTの署名検証・トークン失効設計**
- **セッションIDのスコープ管理（ドメイン/パス）**
- **セキュアクッキーとCSRF防止策の連携**
- パスワードハッシュの推奨アルゴリズム
- API経由の認証情報送信時のリスク（Basic認証、Token型など）

---

### 7. 最新動向

#### 🔐 FIDO2／WebAuthn：パスワードレスの新標準

- **背景**：パスワードに依存した認証では、漏洩・再利用・フィッシングに限界
- **仕組み**：
  - 公開鍵暗号を使ったクライアント証明
  - 認証器（セキュリティキー／OS内蔵TPM等）が秘密鍵を保持
- **プロトコル構成**：
  - FIDO2 = WebAuthn（API）+ CTAP2（認証器連携）

**メリット：**
- 認証情報がサーバに保存されない（プライバシー保護）
- フィッシング耐性が極めて高い

**課題：**
- 対応ブラウザ／端末依存
- 認証器の紛失対応（リカバリ問題）

#### 🌐 IDaaS（Identity as a Service）

- **内容**：クラウド上でID管理・認証基盤を提供するサービス
- **代表例**：Azure AD、Okta、OneLogin
- **特徴**：
  - SAML／OIDC／SCIM連携による統合
  - 管理者不要な即時プロビジョニング（Just-In-Time）

**導入メリット：**
- 内製開発不要、スケーラブル、障害耐性
- SaaS連携前提のゼロトラスト設計に適合

#### 🪪 DID／VC（分散型IDと検証可能資格情報）

- **目的**：中央集権的IdPを不要にし、**自己主権型ID（SSI）**を実現
- **構成要素**：
  - **DID Document**：公開鍵とメタ情報の宣言
  - **VC（Verifiable Credential）**：署名付き資格情報
  - **Holder**／**Verifier**／**Issuer**の三者構造

**用途例**：
- 大学卒業証明、ライセンス、本人確認情報などの分散管理
- EUのeIDAS規格との連携

**課題：**
- 標準化・相互運用性
- DID発行の信頼担保
- ユーザー管理負担の重さ

#### 📌 試験対策視点

- FIDO2の技術構造（WebAuthn＋公開鍵認証）
- IDaaS導入時のSCIM／JITプロビジョニングの概念
- DID／VCの三者モデルとブロックチェーン利用意義
- SSO／MFAの設計とパスワードレス認証の比較

### 8. 試験対策ポイント

- 各認証方式・認可方式の**特徴／長所短所／脆弱性**の把握
- **SAML／OAuth／OIDCのデータフローとトークンの理解**
- セッション管理・トークン管理における実装リスクと対策
- **MFA、SSO、FIDO2**の比較と導入メリット
- **フェデレーション構成におけるIdP／SPの役割**
