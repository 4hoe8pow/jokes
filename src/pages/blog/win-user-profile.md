---
layout: ../../layouts/BlogLayout.astro
title: ADでパスワードリセットしたユーザがログインに黒画面のときの復旧方法
description: Windows 黒画面・プロファイル破損トラブルシューティング
tags: ["情報基礎理論", "エントロピー", "シャノン", "熱力学", "情報物理学"]
time: 5
featured: true
timestamp: 2025-08-22T09:31:03+00:00
filename: win-user-profile
---

## 事象
- AD環境下でユーザのパスワードリセット後、Windowsにログインすると **黒画面**（デスクトップ・タスクバー・スタートメニューが表示されない）  
- マウス右クリックも反応せず、RDP接続でも同様  
- 手動で `explorer.exe` を起動すると GUI が復帰  
- 設定アプリ（`ms-settings:display`）が開けないエラーが発生  

---

## 原因
1. **ユーザープロファイル破損／不整合**
   - パスワードリセットによりプロファイルの資格情報キャッシュやレジストリ設定が正しく読み込めず、Explorer.exe（シェル）の自動起動が失敗  
   - `C:\Users\<username>` 内の設定が壊れている、または一時プロファイルが生成される場合もある  

2. **Explorer.exe の自動起動失敗**
   - 黒画面の本質は「ログオンは成功しているがシェルが立ち上がらない状態」  
   - 手動で `explorer.exe` を起動するとデスクトップ・タスクバーが復帰  

3. **既定アプリや設定アプリ関連のレジストリ不整合**
   - `ms-settings:display` エラーなど、UWPアプリ関連の既定ハンドラがプロファイル内で正しく設定されていない場合に発生  

---

## 確認手順
1. **タスクマネージャーの起動**
   - RDP環境では `Ctrl+Alt+End` → 「タスクマネージャー」を選択  
   - `explorer.exe` が起動中か確認  
     - 無ければ「ファイル → 新しいタスクの実行 → explorer.exe」で手動起動

2. **イベントビューアーの確認**
   - `User Profile Service` ログ（イベントID 1511 / 1515 / 1518）  
   - Application / System ログも併せてチェック

3. **プロファイルの確認**
   - `C:\Users\<username>` フォルダの存在と内容確認  
   - 新しいプロファイルが作成されている場合は `<username>.<domain>` のような末尾が付くこともある  

---

## 復旧手順（安全策）

### 1. 新しい管理者アカウント作成
1. `compmgmt.msc` → 「ローカルユーザーとグループ」 → 新規ユーザー作成  
2. 「Administrators」グループに追加  
3. 新しい管理者でログオン  

### 2. 壊れた管理者プロファイルの退避
1. 新しい管理者でログオン  
2. `C:\Users\<壊れた管理者>` を `<username>.old` にリネーム  
3. 必要なデータ（Desktop, Documents, Downloads 等）をバックアップ  

### 3. レジストリの整理
1. `regedit` を開く  
2. `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\ProfileList`  
3. 壊れたユーザの SID キーをエクスポートしてバックアップ → 削除  
4. 次回ログオン時に新しいプロファイルが生成される  

### 4. プロファイル再生成
- 元の管理者アカウントで再ログオン  
- 新規プロファイルが作成され、Explorer や設定アプリが正常に動作するか確認  

### 5. データ復旧
- `.old` フォルダから必要なファイルをコピー  
- Outlook プロファイルやアプリケーション設定は必要に応じて再構築  

---

## 追加操作
- **資格情報マネージャーの起動**
  - タスクマネージャー → 「ファイル → 新しいタスクの実行」  
  - コマンド： `control /name Microsoft.CredentialManager`  

- **Explorer.exe 手動起動**
  - 黒画面復帰の応急対応として有効  
  - タスクマネージャー → 「ファイル → 新しいタスクの実行 → explorer.exe」  

---

## ユーザープロファイルについて

### 定義
Windowsのユーザープロファイルとは、特定ユーザがログオンした際に利用する **個人専用の作業環境と設定の集合体** です。  
ユーザープロファイルは、デスクトップ、ドキュメント、ダウンロード、アプリ設定、資格情報などを保持し、他のユーザと環境を分離します。

---

### 構成要素
1. **プロファイルフォルダ**
   - `C:\Users\<username>` 内に存在
   - デスクトップ、ドキュメント、ダウンロード、AppData など
   - アプリケーションごとの設定・キャッシュも格納

2. **レジストリユーザハイブ**
   - `HKEY_CURRENT_USER` にマッピング
   - `NTUSER.DAT` ファイルとしてプロファイル内に保存される
   - 壁紙やテーマ、アプリ設定などを保持

3. **資格情報や証明書**
   - Credential Manager や証明書ストアに格納
   - ネットワーク接続やアプリログオンに使用

---

### プロファイルの種類
| 種類 | 説明 |
|------|------|
| ローカルプロファイル | PC内だけに保存される |
| ローミングプロファイル | ドメイン環境でサーバに保存され、どのPCでも同じ環境が再現可能 |
| 一時プロファイル | 読み込み失敗時に作られる一時的なプロファイル。ログオフで消える |

---

### 重要性
- プロファイル破損は **Explorerが起動しない、設定アプリが開けない、資格情報が使えない** 等の現象を引き起こす
- 安全な復旧手段は **新規プロファイル作成 → データ移行**
- レジストリ `ProfileList` と `C:\Users` の整合性が重要

---

## まとめ
- 黒画面の多くは **プロファイル破損またはExplorer自動起動失敗** が原因
- 手動で `explorer.exe` を起動すると一時的に復帰するが、根本的な修復にはプロファイル再生成が必要
- 壊れた管理者プロファイルを直接修復するより、**新しい管理者アカウント作成 → 壊れたプロファイル退避 → 再生成** が安全かつ再発防止策
